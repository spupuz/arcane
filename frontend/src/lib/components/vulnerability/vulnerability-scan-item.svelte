<script lang="ts">
	import * as ArcaneTooltip from '$lib/components/arcane-tooltip';
	import { Spinner } from '$lib/components/ui/spinner/index.js';
	import { ArcaneButton } from '$lib/components/arcane-button';
	import { toast } from 'svelte-sonner';
	import { onDestroy } from 'svelte';
	import type { VulnerabilityScanSummary } from '$lib/types/vulnerability.type';
	import { m } from '$lib/paraglide/messages';
	import { queryKeys } from '$lib/query/query-keys';
	import { vulnerabilityService } from '$lib/services/vulnerability-service';
	import { startVulnerabilityScanPolling } from '$lib/utils/vulnerability-scan.util';
	import { ShieldCheckIcon, ShieldAlertIcon, ScanIcon, ShieldXIcon } from '$lib/icons';
	import { createMutation, useQueryClient } from '@tanstack/svelte-query';

	interface Props {
		scanSummary?: VulnerabilityScanSummary;
		imageId: string;
		onScanned?: (data: VulnerabilityScanSummary) => void;
		pollingEnabled?: boolean;
	}

	let { scanSummary = $bindable(), imageId, onScanned, pollingEnabled = true }: Props = $props();

	let isOpen = $state(false);
	let stopPolling: (() => void) | null = $state(null);
	const queryClient = useQueryClient();
	const scanMutation = createMutation(() => ({
		mutationFn: () => vulnerabilityService.scanImage(imageId)
	}));
	const isScanning = $derived(scanMutation.isPending);

	const hasError = $derived(scanSummary?.status === 'failed' || !!scanSummary?.error);
	const isCompleted = $derived(scanSummary?.status === 'completed');
	const hasCritical = $derived((scanSummary?.summary?.critical ?? 0) > 0);
	const hasHigh = $derived((scanSummary?.summary?.high ?? 0) > 0);
	const hasMedium = $derived((scanSummary?.summary?.medium ?? 0) > 0);
	const hasLow = $derived((scanSummary?.summary?.low ?? 0) > 0);
	const hasAnyVuln = $derived((scanSummary?.summary?.total ?? 0) > 0);
	const totalCount = $derived(scanSummary?.summary?.total ?? 0);

	const statusLabel = $derived.by(() => {
		if (!scanSummary) return m.vuln_no_scan();
		if (scanSummary.status === 'failed') return m.common_error();
		if (scanSummary.status === 'scanning') return m.vuln_scanning();
		if (scanSummary.summary?.total === 0) return m.vuln_clean();
		if ((scanSummary.summary?.critical ?? 0) > 0) return m.vuln_severity_critical();
		if ((scanSummary.summary?.high ?? 0) > 0) return m.vuln_severity_high();
		if ((scanSummary.summary?.medium ?? 0) > 0) return m.vuln_severity_medium();
		if ((scanSummary.summary?.low ?? 0) > 0) return m.vuln_severity_low();
		return m.vuln_severity_unknown();
	});

	const statusVariant = $derived.by(() => {
		if (hasError) return 'red';
		if (!isCompleted) return 'gray';
		if (totalCount === 0) return 'emerald';
		if (totalCount < 10) return 'amber';
		if (totalCount < 50) return 'orange';
		return 'red';
	});

	const statusBadgeText = $derived.by(() => {
		if (!isCompleted) return statusLabel;
		return `${statusLabel} Â· ${totalCount}`;
	});

	const triggerDotClass = $derived.by(() => {
		if (hasError) return 'bg-red-500';
		if (!isCompleted) return 'bg-muted-foreground/50';
		if (totalCount === 0) return 'bg-emerald-500';
		if (hasCritical) return 'bg-red-500';
		if (hasHigh) return 'bg-orange-500';
		if (hasMedium) return 'bg-amber-500';
		if ((scanSummary?.summary?.low ?? 0) > 0) return 'bg-yellow-500';
		return 'bg-gray-400';
	});

	const severitySegments = $derived.by(() => {
		const summary = scanSummary?.summary;
		if (!summary) return [] as Array<{ key: string; pct: number; barClass: string }>;
		const total = Math.max(summary.total, 1);
		return [
			{ key: 'critical', pct: (summary.critical / total) * 100, barClass: 'bg-red-500' },
			{ key: 'high', pct: (summary.high / total) * 100, barClass: 'bg-orange-500' },
			{ key: 'medium', pct: (summary.medium / total) * 100, barClass: 'bg-amber-500' },
			{ key: 'low', pct: (summary.low / total) * 100, barClass: 'bg-yellow-500' },
			{ key: 'unknown', pct: (summary.unknown / total) * 100, barClass: 'bg-gray-400' }
		].filter((segment) => segment.pct > 0);
	});

	async function startScan() {
		if (isScanning) return;

		try {
			const result = await scanMutation.mutateAsync();
			if (result) {
				const summary: VulnerabilityScanSummary = {
					imageId: result.imageId,
					scanTime: result.scanTime,
					status: result.status,
					summary: result.summary,
					error: result.error
				};
				scanSummary = summary;
				onScanned?.(summary);
				if (result.status === 'completed') {
					toast.success(m.vuln_scan_completed());
				} else if (result.status === 'failed') {
					toast.error(result.error || m.vuln_scan_failed());
				} else if (pollingEnabled) {
					beginPolling(true);
				}
			}
		} catch (error) {
			console.error('Error scanning image:', error);
			toast.error(m.vuln_scan_failed());
		} finally {
			// no-op, TanStack manages pending state
		}
	}

	function stopScanPolling() {
		if (stopPolling) {
			stopPolling();
			stopPolling = null;
		}
	}

	function beginPolling(showToast: boolean) {
		if (stopPolling) return;
		const cancel = startVulnerabilityScanPolling(
			imageId,
			(id) =>
				queryClient.fetchQuery({
					queryKey: queryKeys.vulnerabilities.summaryByImage(id),
					queryFn: () => vulnerabilityService.getScanSummary(id),
					staleTime: 0
				}),
			{
				onUpdate: (summary) => {
					scanSummary = summary;
					onScanned?.(summary);
				},
				onComplete: (summary) => {
					scanSummary = summary;
					onScanned?.(summary);
					stopScanPolling();
					if (showToast) {
						if (summary.status === 'completed') {
							toast.success(m.vuln_scan_completed());
						} else {
							toast.error(summary.error || m.vuln_scan_failed());
						}
					}
				},
				onError: () => {}
			}
		);

		stopPolling = cancel;
	}

	$effect(() => {
		if (!pollingEnabled) {
			stopScanPolling();
			return;
		}
		const scanning = scanSummary?.status === 'scanning' || scanSummary?.status === 'pending';
		if (scanning) {
			beginPolling(false);
		} else {
			stopScanPolling();
		}
	});

	onDestroy(() => {
		stopScanPolling();
	});
</script>

{#snippet severityBadge(count: number, label: string, colorClass: string)}
	{#if count > 0}
		<div class="flex items-center justify-between text-xs">
			<span class={colorClass}>{label}</span>
			<span class="font-mono font-medium {colorClass}">{count}</span>
		</div>
	{/if}
{/snippet}

{#snippet tooltipContent()}
	<div class="max-w-[240px] space-y-3 p-3">
		{#if hasError}
			<div class="flex items-center gap-2 text-red-500">
				<ShieldXIcon class="size-4" />
				<span class="text-sm font-medium">{m.vuln_scan_failed()}</span>
			</div>
			{#if scanSummary?.error}
				<p class="text-muted-foreground text-xs">{scanSummary.error}</p>
			{/if}
		{:else if scanSummary?.status === 'scanning' || isScanning}
			<div class="flex items-center gap-2 text-blue-500">
				<Spinner class="size-4" />
				<span class="text-sm font-medium">{m.vuln_scanning()}</span>
			</div>
		{:else if isCompleted && scanSummary?.summary}
			<div class="space-y-2">
				<div class="flex items-center gap-2">
					{#if hasCritical}
						<ShieldAlertIcon class="size-4 text-red-500" />
					{:else if hasHigh}
						<ShieldAlertIcon class="size-4 text-orange-500" />
					{:else if hasMedium}
						<ShieldAlertIcon class="size-4 text-amber-500" />
					{:else if hasAnyVuln}
						<ShieldAlertIcon class="size-4 text-yellow-500" />
					{:else}
						<ShieldCheckIcon class="size-4 text-emerald-500" />
					{/if}
					<div>
						<p class="text-sm font-medium">{statusLabel}</p>
						<p class="text-muted-foreground text-xs">{m.vuln_summary()}</p>
					</div>
				</div>
				<div class="bg-muted/40 rounded-md p-2">
					<div class="flex items-center justify-between text-xs">
						<span class="text-muted-foreground">{m.common_total()}</span>
						<span class="font-mono">{totalCount}</span>
					</div>
					<div class="bg-muted/70 mt-2 flex h-2 overflow-hidden rounded-full">
						{#each severitySegments as segment (segment.key)}
							<div class={segment.barClass} style={`width: ${segment.pct}%`}></div>
						{/each}
					</div>
				</div>
				<div class="space-y-1.5">
					{@render severityBadge(scanSummary.summary.critical, m.vuln_severity_critical(), 'text-red-500')}
					{@render severityBadge(scanSummary.summary.high, m.vuln_severity_high(), 'text-orange-500')}
					{@render severityBadge(scanSummary.summary.medium, m.vuln_severity_medium(), 'text-amber-500')}
					{@render severityBadge(scanSummary.summary.low, m.vuln_severity_low(), 'text-yellow-600')}
					{@render severityBadge(scanSummary.summary.unknown, m.vuln_severity_unknown(), 'text-gray-500')}
				</div>
				{#if !hasAnyVuln}
					<p class="text-xs text-emerald-500">{m.vuln_no_vulnerabilities()}</p>
				{/if}
			</div>
		{:else}
			<div class="text-muted-foreground flex items-center gap-2">
				<ScanIcon class="size-4" />
				<span class="text-sm font-medium">{m.vuln_no_scan()}</span>
			</div>
			<p class="text-muted-foreground text-xs">
				{m.vuln_click_to_scan()}
			</p>
		{/if}

		{#if !isScanning && scanSummary?.status !== 'scanning'}
			<button
				onclick={startScan}
				disabled={isScanning}
				class="bg-secondary text-secondary-foreground hover:bg-secondary/80 w-full rounded-md px-3 py-1.5 text-xs font-medium transition-colors disabled:opacity-50"
			>
				{isScanning
					? m.vuln_scanning()
					: scanSummary?.status === 'completed' || scanSummary?.status === 'failed'
						? m.vuln_rescan()
						: m.vuln_scan()}
			</button>
		{/if}
	</div>
{/snippet}

<ArcaneTooltip.Root bind:open={isOpen} interactive>
	<ArcaneTooltip.Trigger>
		<div class="flex w-16 flex-col items-center gap-1">
			{#if isScanning || scanSummary?.status === 'scanning'}
				<div class="flex items-center justify-center gap-1.5 text-xs text-blue-500">
					<Spinner class="size-3 shrink-0" />
					<span class="truncate">{m.vuln_scanning()}</span>
				</div>
			{:else if hasError}
				<div class="flex items-center justify-center gap-1.5 text-xs text-red-500">
					<ShieldXIcon class="size-3 shrink-0" />
					<span class="truncate">{m.vuln_scan_failed()}</span>
				</div>
			{:else if isCompleted}
				<div
					class="border-border/50 bg-muted/20 flex w-full min-w-0 items-center justify-center gap-1.5 rounded-md border px-2 py-1"
				>
					<span class="{triggerDotClass} size-2 shrink-0 rounded-full" aria-hidden="true"></span>
					<span class="text-foreground text-xs font-medium tabular-nums">{totalCount}</span>
				</div>
			{:else}
				<div class="flex justify-center">
					<ArcaneButton
						action="base"
						tone="ghost"
						size="icon"
						icon={ScanIcon}
						showLabel={false}
						customLabel={m.vuln_scan()}
						onclick={startScan}
						disabled={isScanning}
						class="size-7"
					/>
				</div>
			{/if}
		</div>
	</ArcaneTooltip.Trigger>
	<ArcaneTooltip.Content side="right">
		{@render tooltipContent()}
	</ArcaneTooltip.Content>
</ArcaneTooltip.Root>
