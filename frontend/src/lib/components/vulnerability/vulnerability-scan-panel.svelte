<script lang="ts">
	import * as Card from '$lib/components/ui/card';
	import ArcaneTable from '$lib/components/arcane-table/arcane-table.svelte';
	import UniversalMobileCard from '$lib/components/arcane-table/cards/universal-mobile-card.svelte';
	import { ArcaneButton } from '$lib/components/arcane-button';
	import { queryKeys } from '$lib/query/query-keys';
	import { Spinner } from '$lib/components/ui/spinner';
	import StatusBadge from '$lib/components/badges/status-badge.svelte';
	import { m } from '$lib/paraglide/messages';
	import { vulnerabilityService } from '$lib/services/vulnerability-service.js';
	import type { ColumnSpec } from '$lib/components/arcane-table/arcane-table.types.svelte';
	import type { VulnerabilityScanResult, Vulnerability as VulnType, SeveritySummary } from '$lib/types/vulnerability.type';
	import type { Paginated, SearchPaginationSortRequest } from '$lib/types/pagination.type';
	import { ShieldCheckIcon, ShieldAlertIcon, ShieldXIcon, ScanIcon, CodeIcon, CheckIcon } from '$lib/icons';
	import { useQueryClient } from '@tanstack/svelte-query';

	interface Props {
		scan?: VulnerabilityScanResult | null;
		isScanning?: boolean;
		onScan?: () => void;
	}

	let { scan, isScanning = false, onScan }: Props = $props();
	const queryClient = useQueryClient();

	const DEFAULT_PAGE_SIZE = 20;

	type VulnerabilityRow = VulnType & { id: string };

	function buildSeveritySummary(vulns: VulnType[]): SeveritySummary {
		const summary: SeveritySummary = {
			critical: 0,
			high: 0,
			medium: 0,
			low: 0,
			unknown: 0,
			total: 0
		};

		for (const vuln of vulns) {
			switch (vuln.severity) {
				case 'CRITICAL':
					summary.critical++;
					break;
				case 'HIGH':
					summary.high++;
					break;
				case 'MEDIUM':
					summary.medium++;
					break;
				case 'LOW':
					summary.low++;
					break;
				default:
					summary.unknown++;
			}
			summary.total++;
		}

		return summary;
	}

	const resolvedSummary = $derived.by(() => {
		if (scan?.summary) return scan.summary;
		if (scan?.vulnerabilities?.length) {
			return buildSeveritySummary(scan.vulnerabilities);
		}
		return undefined;
	});

	let vulnerabilityRequestOptions = $state<SearchPaginationSortRequest>({
		pagination: { page: 1, limit: DEFAULT_PAGE_SIZE },
		sort: { column: 'vulnSeverity', direction: 'desc' }
	});

	let vulnerabilityItems = $state<Paginated<VulnerabilityRow>>({
		data: [],
		pagination: {
			totalPages: 1,
			totalItems: 0,
			currentPage: 1,
			itemsPerPage: DEFAULT_PAGE_SIZE,
			grandTotalItems: 0
		}
	});

	const columns = $derived([
		{ accessorKey: 'vulnerabilityId', title: 'CVE', cell: CveCell },
		{ accessorKey: 'pkgName', title: m.vuln_package(), cell: PackageCell },
		{ id: 'vulnSeverity', accessorKey: 'severity', title: m.events_col_severity(), sortable: true, cell: SeverityCell },
		{ accessorKey: 'installedVersion', title: m.vuln_installed_version(), cell: InstalledCell },
		{ accessorKey: 'fixedVersion', title: m.vuln_fixed_version(), cell: FixedCell }
	] satisfies ColumnSpec<VulnerabilityRow>[]);

	const mobileFields = [
		{ id: 'vulnerabilityId', label: 'CVE', defaultVisible: true },
		{ id: 'pkgName', label: m.vuln_package(), defaultVisible: true },
		{ id: 'vulnSeverity', label: m.events_col_severity(), defaultVisible: true },
		{ id: 'installedVersion', label: m.vuln_installed_version(), defaultVisible: false },
		{ id: 'fixedVersion', label: m.vuln_fixed_version(), defaultVisible: false }
	];

	const severityBars = $derived.by(() => {
		if (!resolvedSummary)
			return [] as Array<{
				key: string;
				label: string;
				count: number;
				pct: number;
				barClass: string;
				textClass: string;
			}>;
		const total = Math.max(resolvedSummary.total, 1);
		return [
			{
				key: 'critical',
				label: m.vuln_severity_critical(),
				count: resolvedSummary.critical,
				pct: (resolvedSummary.critical / total) * 100,
				barClass: 'bg-red-500',
				textClass: 'text-red-500'
			},
			{
				key: 'high',
				label: m.vuln_severity_high(),
				count: resolvedSummary.high,
				pct: (resolvedSummary.high / total) * 100,
				barClass: 'bg-orange-500',
				textClass: 'text-orange-500'
			},
			{
				key: 'medium',
				label: m.vuln_severity_medium(),
				count: resolvedSummary.medium,
				pct: (resolvedSummary.medium / total) * 100,
				barClass: 'bg-amber-500',
				textClass: 'text-amber-500'
			},
			{
				key: 'low',
				label: m.vuln_severity_low(),
				count: resolvedSummary.low,
				pct: (resolvedSummary.low / total) * 100,
				barClass: 'bg-yellow-500',
				textClass: 'text-yellow-600'
			},
			{
				key: 'unknown',
				label: m.vuln_severity_unknown(),
				count: resolvedSummary.unknown,
				pct: (resolvedSummary.unknown / total) * 100,
				barClass: 'bg-gray-400',
				textClass: 'text-gray-500'
			}
		].filter((bar) => bar.count > 0);
	});

	const scanStatusLabel = $derived.by(() => {
		if (!resolvedSummary) return m.common_unknown();
		if (resolvedSummary.total === 0) return m.vuln_clean();
		if (resolvedSummary.critical > 0) return m.vuln_severity_critical();
		if (resolvedSummary.high > 0) return m.vuln_severity_high();
		if (resolvedSummary.medium > 0) return m.vuln_severity_medium();
		if (resolvedSummary.low > 0) return m.vuln_severity_low();
		return m.vuln_severity_unknown();
	});

	const scanStatusTone = $derived.by(() => {
		if (!resolvedSummary) return 'bg-muted text-muted-foreground';
		if (resolvedSummary.total === 0) return 'bg-emerald-500/15 text-emerald-500 ring-emerald-500/30';
		if (resolvedSummary.critical > 0) return 'bg-red-500/15 text-red-500 ring-red-500/30';
		if (resolvedSummary.high > 0) return 'bg-orange-500/15 text-orange-500 ring-orange-500/30';
		if (resolvedSummary.medium > 0) return 'bg-amber-500/15 text-amber-500 ring-amber-500/30';
		if (resolvedSummary.low > 0) return 'bg-yellow-500/15 text-yellow-600 ring-yellow-500/30';
		return 'bg-gray-500/15 text-gray-500 ring-gray-500/30';
	});

	const scanDurationLabel = $derived.by(() => {
		const durationMs = scan?.duration ?? 0;
		if (!durationMs) return m.common_na();
		if (durationMs < 1000) return `${durationMs} ms`;
		return `${(durationMs / 1000).toFixed(1)} s`;
	});

	const headerIcon = $derived.by(() => {
		const isClean = scan?.status === 'completed' && (resolvedSummary?.total ?? 0) === 0;
		return isClean ? ShieldCheckIcon : ShieldAlertIcon;
	});

	const isWorking = $derived.by(() => isScanning || scan?.status === 'scanning');
	const hasError = $derived.by(() => scan?.status === 'failed' || !!scan?.error);

	function getSeverityLabel(severity: string): string {
		switch (severity) {
			case 'CRITICAL':
				return m.vuln_severity_critical();
			case 'HIGH':
				return m.vuln_severity_high();
			case 'MEDIUM':
				return m.vuln_severity_medium();
			case 'LOW':
				return m.vuln_severity_low();
			default:
				return m.vuln_severity_unknown();
		}
	}

	function getSeverityBadgeVariant(severity: string): 'red' | 'orange' | 'amber' | 'green' | 'gray' {
		switch (severity) {
			case 'CRITICAL':
				return 'red';
			case 'HIGH':
				return 'orange';
			case 'MEDIUM':
				return 'amber';
			case 'LOW':
				return 'green';
			default:
				return 'gray';
		}
	}

	function getSeverityIconVariant(severity: string): 'red' | 'orange' | 'amber' | 'emerald' | 'gray' {
		switch (severity) {
			case 'CRITICAL':
				return 'red';
			case 'HIGH':
				return 'orange';
			case 'MEDIUM':
				return 'amber';
			case 'LOW':
				return 'emerald';
			default:
				return 'gray';
		}
	}

	function getVulnerabilityKey(vuln: VulnType, index: number): string {
		return [vuln.vulnerabilityId, vuln.pkgName, vuln.installedVersion ?? '', vuln.fixedVersion ?? '', String(index)].join('-');
	}

	async function refreshVulnerabilityTable(options: SearchPaginationSortRequest) {
		if (!scan?.imageId) {
			const empty: Paginated<VulnerabilityRow> = {
				data: [],
				pagination: {
					totalPages: 1,
					totalItems: 0,
					currentPage: 1,
					itemsPerPage: DEFAULT_PAGE_SIZE,
					grandTotalItems: 0
				}
			};
			vulnerabilityItems = empty;
			return empty;
		}

		const mergedFilters = { ...(options.filters ?? {}) };
		if (mergedFilters.vulnSeverity) {
			mergedFilters.severity = mergedFilters.vulnSeverity;
			delete mergedFilters.vulnSeverity;
		}

		const sort = options.sort?.column === 'vulnSeverity' ? { ...options.sort, column: 'severity' } : options.sort;

		const request: SearchPaginationSortRequest = {
			...options,
			sort,
			filters: Object.keys(mergedFilters).length ? mergedFilters : undefined
		};

		const response = await queryClient.fetchQuery({
			queryKey: queryKeys.vulnerabilities.imageRows(scan.imageId, request),
			queryFn: () => vulnerabilityService.getImageVulnerabilities(scan.imageId, request),
			staleTime: 0
		});
		const page = request.pagination?.page ?? 1;
		const limit = request.pagination?.limit ?? DEFAULT_PAGE_SIZE;
		const offset = (page - 1) * limit;
		const mapped: Paginated<VulnerabilityRow> = {
			...response,
			data: (response.data ?? []).map((item, index) => ({
				...item,
				id: getVulnerabilityKey(item, offset + index)
			}))
		};
		vulnerabilityItems = mapped;
		return mapped;
	}

	let lastScanKey = '';
	$effect(() => {
		const scanKey = scan ? `${scan.imageId}:${scan.scanTime}` : '';
		const totalVulns = resolvedSummary?.total ?? 0;
		if (!scan?.imageId || scan?.status !== 'completed' || totalVulns === 0) {
			lastScanKey = scanKey;
			return;
		}
		if (scanKey && scanKey !== lastScanKey) {
			lastScanKey = scanKey;
			void refreshVulnerabilityTable(vulnerabilityRequestOptions);
		}
	});
</script>

{#snippet CveCell({ item }: { item: VulnerabilityRow })}
	<a
		href="https://nvd.nist.gov/vuln/detail/{item.vulnerabilityId}"
		target="_blank"
		rel="noopener noreferrer"
		class="font-mono text-xs text-blue-600 hover:underline dark:text-blue-400"
	>
		{item.vulnerabilityId}
	</a>
{/snippet}

{#snippet PackageCell({ item }: { item: VulnerabilityRow })}
	<span class="font-mono text-xs">{item.pkgName}</span>
{/snippet}

{#snippet SeverityCell({ item }: { item: VulnerabilityRow })}
	{#if item.severity === 'CRITICAL'}
		<StatusBadge text={m.vuln_severity_critical()} variant="red" size="sm" />
	{:else if item.severity === 'HIGH'}
		<StatusBadge text={m.vuln_severity_high()} variant="orange" size="sm" />
	{:else if item.severity === 'MEDIUM'}
		<StatusBadge text={m.vuln_severity_medium()} variant="amber" size="sm" />
	{:else if item.severity === 'LOW'}
		<StatusBadge text={m.vuln_severity_low()} variant="lime" size="sm" />
	{:else}
		<StatusBadge text={m.vuln_severity_unknown()} variant="gray" size="sm" />
	{/if}
{/snippet}

{#snippet InstalledCell({ item }: { item: VulnerabilityRow })}
	<span class="font-mono text-xs">{item.installedVersion}</span>
{/snippet}

{#snippet FixedCell({ item }: { item: VulnerabilityRow })}
	<span class="font-mono text-xs">{item.fixedVersion || m.vuln_no_fix()}</span>
{/snippet}

{#snippet VulnerabilityMobileCard({
	row,
	item,
	mobileFieldVisibility
}: {
	row: any;
	item: VulnerabilityRow;
	mobileFieldVisibility: Record<string, boolean>;
})}
	<UniversalMobileCard
		{item}
		icon={(item) => ({
			component: ShieldAlertIcon,
			variant: getSeverityIconVariant(item.severity)
		})}
		title={(item) => item.vulnerabilityId}
		subtitle={(item) => ((mobileFieldVisibility.pkgName ?? true) ? item.pkgName : null)}
		badges={[
			(item) =>
				(mobileFieldVisibility.vulnSeverity ?? true)
					? { variant: getSeverityBadgeVariant(item.severity), text: getSeverityLabel(item.severity) }
					: null
		]}
		fields={[
			{
				label: m.vuln_installed_version(),
				getValue: (item) => item.installedVersion,
				type: 'mono',
				icon: CodeIcon,
				iconVariant: 'blue',
				show: mobileFieldVisibility.installedVersion ?? true
			},
			{
				label: m.vuln_fixed_version(),
				getValue: (item) => item.fixedVersion || m.vuln_no_fix(),
				type: 'mono',
				icon: CheckIcon,
				iconVariant: item.fixedVersion ? 'emerald' : 'gray',
				show: mobileFieldVisibility.fixedVersion ?? true
			}
		]}
	/>
{/snippet}

<Card.Root>
	<Card.Header icon={headerIcon}>
		<div class="flex flex-col space-y-1.5">
			<Card.Title>{m.vuln_title()}</Card.Title>
			<Card.Description>
				{#if scan?.status === 'completed'}
					{m.vuln_scan_time()}: {scan ? new Date(scan.scanTime).toLocaleString() : m.common_na()}
				{:else if isWorking}
					{m.vuln_scanning()}
				{:else}
					{m.vuln_no_scan()}
				{/if}
			</Card.Description>
		</div>
	</Card.Header>
	<Card.Content class="p-4">
		{#if isWorking}
			<div class="flex items-center justify-center py-8">
				<Spinner class="size-8" />
				<span class="text-muted-foreground ml-3">{m.vuln_scanning()}</span>
			</div>
		{:else if scan?.status === 'completed' && resolvedSummary}
			{@const summary = resolvedSummary}
			{#if summary.total === 0}
				<div class="rounded-2xl border border-emerald-500/20 bg-emerald-500/5 p-6 shadow-sm">
					<div class="flex items-center gap-4">
						<div class="rounded-full bg-emerald-500/15 p-3">
							<ShieldCheckIcon class="size-6 text-emerald-500" />
						</div>
						<div class="space-y-1">
							<p class="text-xs font-semibold tracking-wide text-emerald-400 uppercase">{m.vuln_summary()}</p>
							<p class="text-lg font-semibold text-emerald-200">{m.vuln_clean()}</p>
							<p class="text-sm text-emerald-300/80">{m.vuln_no_vulnerabilities()}</p>
						</div>
					</div>
					<div class="text-muted-foreground mt-4 flex flex-wrap gap-2 text-xs">
						<span class="bg-muted/50 rounded-full px-2 py-1">{scanDurationLabel}</span>
						{#if scan?.scannerVersion}
							<span class="bg-muted/50 rounded-full px-2 py-1">Trivy {scan.scannerVersion}</span>
						{/if}
					</div>
				</div>
			{:else}
				<div class="grid gap-4 xl:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
					<div class="border-border/60 bg-muted/30 rounded-2xl border p-5 shadow-sm">
						<div class="flex items-center justify-between">
							<p class="text-muted-foreground text-xs font-semibold tracking-wide uppercase">{m.vuln_summary()}</p>
							<span class={`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${scanStatusTone}`}>
								{scanStatusLabel}
							</span>
						</div>
						<div class="mt-5 flex items-end gap-4">
							<div class="text-5xl leading-none font-semibold tracking-tight">{summary.total}</div>
							<div class="text-muted-foreground space-y-1 text-xs">
								<div class="tracking-wide uppercase">{m.common_total()}</div>
								<div>{m.vuln_details()}</div>
							</div>
						</div>
						<div class="mt-5 space-y-2">
							{#each severityBars as bar (bar.key)}
								<div class="flex items-center gap-3 text-xs">
									<span class="text-muted-foreground w-24">{bar.label}</span>
									<div class="bg-muted/60 relative h-2 flex-1 overflow-hidden rounded-full">
										<div class={`h-full ${bar.barClass}`} style={`width: ${bar.pct}%`}></div>
									</div>
									<span class={`w-8 text-right font-mono ${bar.textClass}`}>{bar.count}</span>
								</div>
							{/each}
						</div>
						<div class="text-muted-foreground mt-4 flex flex-wrap gap-2 text-xs">
							<span class="bg-muted/50 rounded-full px-2 py-1">{scanDurationLabel}</span>
							{#if scan?.scannerVersion}
								<span class="bg-muted/50 rounded-full px-2 py-1">Trivy {scan.scannerVersion}</span>
							{/if}
						</div>
					</div>

					<div class="grid gap-3 sm:grid-cols-2">
						{#each severityBars as bar (bar.key)}
							<div class="border-border/60 bg-muted/30 rounded-xl border p-4 shadow-sm">
								<div class="flex items-center justify-between">
									<span class="text-muted-foreground text-xs font-semibold tracking-wide uppercase">{bar.label}</span>
								</div>
								<div class={`mt-2 text-3xl font-semibold ${bar.textClass}`}>{bar.count}</div>
								<div class="bg-muted/60 mt-3 h-1.5 rounded-full">
									<div class={`h-full ${bar.barClass}`} style={`width: ${bar.pct}%`}></div>
								</div>
							</div>
						{/each}
					</div>
				</div>
			{/if}

			{#if resolvedSummary && resolvedSummary.total > 0}
				<div class="mt-6 space-y-2">
					<h4 class="text-muted-foreground text-sm font-semibold">{m.vuln_details()}</h4>
					<div class="border-border/60 rounded-xl border">
						<ArcaneTable
							items={vulnerabilityItems}
							bind:requestOptions={vulnerabilityRequestOptions}
							onRefresh={refreshVulnerabilityTable}
							{columns}
							mobileCard={VulnerabilityMobileCard}
							{mobileFields}
							selectionDisabled
							unstyled
						/>
					</div>
				</div>
			{/if}
		{:else if hasError}
			<div class="flex items-center gap-3 rounded-lg bg-red-50 p-4 dark:bg-red-950/20">
				<ShieldXIcon class="size-8 text-red-500" />
				<div>
					<p class="font-medium text-red-800 dark:text-red-200">{m.vuln_scan_failed()}</p>
					<p class="text-sm text-red-600 dark:text-red-400">{scan?.error || m.vuln_scanner_not_installed()}</p>
				</div>
			</div>
		{:else}
			<div class="flex flex-col items-center justify-center py-8 text-center">
				<ScanIcon class="text-muted-foreground/50 mb-4 size-12" />
				<p class="text-muted-foreground mb-2">{m.vuln_no_scan()}</p>
				<ArcaneButton action="base" onclick={onScan} disabled={!onScan || isScanning}>
					{#if isScanning}
						<Spinner class="mr-2 size-4" />
					{:else}
						<ScanIcon class="mr-2 size-4" />
					{/if}
					{m.vuln_scan_image()}
				</ArcaneButton>
			</div>
		{/if}
	</Card.Content>
</Card.Root>
