import BaseAPIService from './api-service';
import { environmentStore } from '$lib/stores/environment.store.svelte';
import type {
	VulnerabilityScanResult,
	VulnerabilityScanSummary,
	ScanSummariesResponse,
	ScannerStatus,
	Vulnerability,
	VulnerabilityWithImage,
	EnvironmentVulnerabilitySummary,
	IgnoredVulnerability,
	IgnoreVulnerabilityPayload
} from '$lib/types/vulnerability.type';
import type { Paginated, SearchPaginationSortRequest } from '$lib/types/pagination.type';
import { transformPaginationParams } from '$lib/utils/params.util';

export class VulnerabilityService extends BaseAPIService {
	/**
	 * Scan an image for vulnerabilities
	 */
	async scanImage(imageId: string): Promise<VulnerabilityScanResult> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.post(`/environments/${envId}/images/${imageId}/vulnerabilities/scan`));
	}

	/**
	 * Get the full vulnerability scan result for an image
	 */
	async getScanResult(imageId: string): Promise<VulnerabilityScanResult> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities`));
	}

	/**
	 * Get a paginated list of vulnerabilities for an image
	 */
	async getImageVulnerabilities(imageId: string, options?: SearchPaginationSortRequest): Promise<Paginated<Vulnerability>> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		const params = transformPaginationParams(options);
		const res = await this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities/list`, { params });
		return res.data;
	}

	/**
	 * Get just the vulnerability summary for an image (for list views)
	 */
	async getScanSummary(imageId: string): Promise<VulnerabilityScanSummary> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities/summary`));
	}

	/**
	 * Get vulnerability scan summaries for multiple images (batch)
	 */
	async getScanSummaries(imageIds: string[]): Promise<ScanSummariesResponse> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(
			this.api.post(`/environments/${envId}/images/vulnerabilities/summaries`, {
				imageIds
			})
		);
	}

	/**
	 * Get the scanner status (whether Trivy is available)
	 */
	async getScannerStatus(): Promise<ScannerStatus> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/vulnerabilities/scanner-status`));
	}

	/**
	 * Get aggregated vulnerability summary for the current environment
	 */
	async getEnvironmentSummary(): Promise<EnvironmentVulnerabilitySummary> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/vulnerabilities/summary`));
	}

	/**
	 * Get a paginated list of vulnerabilities across all images
	 */
	async getAllVulnerabilities(options?: SearchPaginationSortRequest): Promise<Paginated<VulnerabilityWithImage>> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		const params = transformPaginationParams(options);
		const res = await this.api.get(`/environments/${envId}/vulnerabilities/all`, { params });
		return res.data;
	}

	/**
	 * Ignore a vulnerability
	 */
	async ignoreVulnerability(payload: IgnoreVulnerabilityPayload): Promise<IgnoredVulnerability> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.post(`/environments/${envId}/vulnerabilities/ignore`, payload));
	}

	/**
	 * Unignore a vulnerability
	 */
	async unignoreVulnerability(ignoreId: string): Promise<void> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		await this.handleResponse(this.api.delete(`/environments/${envId}/vulnerabilities/ignore/${ignoreId}`));
	}

	/**
	 * Get a list of ignored vulnerabilities
	 */
	async getIgnoredVulnerabilities(options?: SearchPaginationSortRequest): Promise<Paginated<IgnoredVulnerability>> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		const params = transformPaginationParams(options);
		const res = await this.api.get(`/environments/${envId}/vulnerabilities/ignored`, { params });
		return res.data;
	}
}

export const vulnerabilityService = new VulnerabilityService();
