package models

import (
	"time"
)

// VulnerabilityScanRecord stores vulnerability scan results for images
type VulnerabilityScanRecord struct {
	// ImageID is the Docker image ID (primary key)
	ID string `json:"id" gorm:"primaryKey;type:text"`

	// ImageName is the image name with tag (e.g., nginx:latest)
	ImageName string `json:"imageName" gorm:"column:image_name"`

	// Status is the status of the scan (pending, scanning, completed, failed)
	Status string `json:"status" gorm:"column:status"`

	// ScanTime is the timestamp when the scan was performed
	ScanTime time.Time `json:"scanTime" gorm:"column:scan_time"`

	// Duration is the duration of the scan in milliseconds
	Duration int64 `json:"duration" gorm:"column:duration"`

	// Total vulnerability counts by severity
	CriticalCount int `json:"criticalCount" gorm:"column:critical_count"`
	HighCount     int `json:"highCount" gorm:"column:high_count"`
	MediumCount   int `json:"mediumCount" gorm:"column:medium_count"`
	LowCount      int `json:"lowCount" gorm:"column:low_count"`
	UnknownCount  int `json:"unknownCount" gorm:"column:unknown_count"`
	TotalCount    int `json:"totalCount" gorm:"column:total_count"`

	// Vulnerabilities stores the JSON encoded vulnerabilities list
	Vulnerabilities StringSlice `json:"vulnerabilities" gorm:"column:vulnerabilities;type:text"`

	// Error contains the error message if the scan failed
	Error *string `json:"error,omitempty" gorm:"column:error"`

	// ScannerVersion is the version of the scanner used
	ScannerVersion string `json:"scannerVersion" gorm:"column:scanner_version"`

	BaseModel
}

func (v *VulnerabilityScanRecord) TableName() string {
	return "vulnerability_scans"
}

// Scan status constants
const (
	ScanStatusPending   = "pending"
	ScanStatusScanning  = "scanning"
	ScanStatusCompleted = "completed"
	ScanStatusFailed    = "failed"
)

// IsCompleted returns true if the scan has completed
func (v *VulnerabilityScanRecord) IsCompleted() bool {
	return v.Status == ScanStatusCompleted
}

// IsFailed returns true if the scan has failed
func (v *VulnerabilityScanRecord) IsFailed() bool {
	return v.Status == ScanStatusFailed
}

// IsScanning returns true if the scan is in progress
func (v *VulnerabilityScanRecord) IsScanning() bool {
	return v.Status == ScanStatusScanning
}

// GetTotalVulnerabilities returns the total count of vulnerabilities
func (v *VulnerabilityScanRecord) GetTotalVulnerabilities() int {
	return v.TotalCount
}

// GetHighestSeverity returns the highest severity level found
func (v *VulnerabilityScanRecord) GetHighestSeverity() string {
	if v.CriticalCount > 0 {
		return "CRITICAL"
	}
	if v.HighCount > 0 {
		return "HIGH"
	}
	if v.MediumCount > 0 {
		return "MEDIUM"
	}
	if v.LowCount > 0 {
		return "LOW"
	}
	if v.UnknownCount > 0 {
		return "UNKNOWN"
	}
	return "NONE"
}
