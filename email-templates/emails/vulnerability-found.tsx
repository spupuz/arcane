import { Column, Hr, Link, Row, Section, Text } from '@react-email/components';
import { BaseTemplate } from '../components/base-template';
import CardHeader from '../components/card-header';
import { sharedPreviewProps, sharedTemplateProps } from '../props';

interface VulnerabilityFoundEmailProps {
  logoURL: string;
  appURL: string;
  cveId: string;
  cveLink: string;
  severity: string;
  imageName: string;
  fixedVersion: string;
  pkgName?: string;
  installedVersion?: string;
}

export const VulnerabilityFoundEmail = ({
  logoURL,
  appURL,
  cveId,
  cveLink,
  severity,
  imageName,
  fixedVersion,
  pkgName,
  installedVersion,
}: VulnerabilityFoundEmailProps) => {
  const severityColor =
    severity === 'CRITICAL'
      ? '#ef4444'
      : severity === 'HIGH'
        ? '#f97316'
        : severity === 'MEDIUM'
          ? '#eab308'
          : severity === 'LOW'
            ? '#22c55e'
            : '#94a3b8';

  return (
    <BaseTemplate logoURL={logoURL} appURL={appURL}>
      <CardHeader title="Vulnerability Found (Fix Available)" />

      <Section style={{ marginTop: '24px' }}>
        <Text style={mainTextStyle}>
          A vulnerability with an available fix was detected in one of your container images. Update to the fixed
          version to resolve the issue.
        </Text>
      </Section>

      <Section style={infoSectionStyle}>
        <Row style={infoRowStyle}>
          <Column style={labelColumnStyle}>
            <Text style={labelStyle}>CVE:</Text>
          </Column>
          <Column>
            {cveLink ? (
              <Link href={cveLink} style={linkStyle}>
                {cveId}
              </Link>
            ) : (
              <Text style={valueStyle}>{cveId}</Text>
            )}
          </Column>
        </Row>

        <Hr style={dividerStyle} />

        <Row style={infoRowStyle}>
          <Column style={labelColumnStyle}>
            <Text style={labelStyle}>Severity:</Text>
          </Column>
          <Column>
            <Text style={{ ...valueStyle, color: severityColor, fontWeight: 600 }}>{severity}</Text>
          </Column>
        </Row>

        <Hr style={dividerStyle} />

        <Row style={infoRowStyle}>
          <Column style={labelColumnStyle}>
            <Text style={labelStyle}>Image:</Text>
          </Column>
          <Column>
            <Text style={valueStyle}>{imageName}</Text>
          </Column>
        </Row>

        <Hr style={dividerStyle} />

        <Row style={infoRowStyle}>
          <Column style={labelColumnStyle}>
            <Text style={labelStyle}>Fixed version:</Text>
          </Column>
          <Column>
            <Text style={fixedVersionStyle}>{fixedVersion}</Text>
          </Column>
        </Row>

        {pkgName && (
          <>
            <Hr style={dividerStyle} />
            <Row style={infoRowStyle}>
              <Column style={labelColumnStyle}>
                <Text style={labelStyle}>Package:</Text>
              </Column>
              <Column>
                <Text style={valueStyle}>{pkgName}</Text>
              </Column>
            </Row>
          </>
        )}

        {installedVersion && (
          <>
            <Hr style={dividerStyle} />
            <Row style={infoRowStyle}>
              <Column style={labelColumnStyle}>
                <Text style={labelStyle}>Installed version:</Text>
              </Column>
              <Column>
                <Text style={valueStyle}>{installedVersion}</Text>
              </Column>
            </Row>
          </>
        )}
      </Section>

      <Section style={{ marginTop: '24px' }}>
        <Text style={footerStyle}>
          This is an automated notification from Arcane. View the Security page in your dashboard for full scan results
          and to re-scan after updating.
        </Text>
      </Section>
    </BaseTemplate>
  );
};

export default VulnerabilityFoundEmail;

const mainTextStyle = {
  fontSize: '16px',
  lineHeight: '24px',
  color: '#cbd5e1',
  margin: '0 0 16px 0',
};

const infoSectionStyle = {
  marginTop: '20px',
  backgroundColor: 'rgba(15, 23, 42, 0.5)',
  border: '1px solid rgba(148, 163, 184, 0.1)',
  padding: '20px',
  borderRadius: '12px',
};

const infoRowStyle = {
  marginBottom: '0',
};

const labelColumnStyle = {
  width: '140px',
  verticalAlign: 'top' as const,
  paddingRight: '12px',
};

const labelStyle = {
  fontSize: '14px',
  fontWeight: '600' as const,
  color: '#94a3b8',
  margin: '8px 0',
};

const valueStyle = {
  fontSize: '14px',
  color: '#e2e8f0',
  margin: '8px 0',
  wordBreak: 'break-word' as const,
};

const fixedVersionStyle = {
  fontSize: '14px',
  fontWeight: '600' as const,
  color: '#34d399',
  margin: '8px 0',
  wordBreak: 'break-word' as const,
};

const linkStyle = {
  color: '#a78bfa',
  textDecoration: 'none',
};

const dividerStyle = {
  borderColor: 'rgba(148, 163, 184, 0.2)',
  margin: '4px 0',
};

const footerStyle = {
  fontSize: '13px',
  lineHeight: '20px',
  color: '#94a3b8',
  margin: '0',
};

VulnerabilityFoundEmail.TemplateProps = {
  ...sharedTemplateProps,
  cveId: '{{.CVEID}}',
  cveLink: '{{.CVELink}}',
  severity: '{{.Severity}}',
  imageName: '{{.ImageName}}',
  fixedVersion: '{{.FixedVersion}}',
  pkgName: '{{.PkgName}}',
  installedVersion: '{{.InstalledVersion}}',
};

VulnerabilityFoundEmail.PreviewProps = {
  ...sharedPreviewProps,
  cveId: 'CVE-2024-1234',
  cveLink: 'https://nvd.nist.gov/vuln/detail/CVE-2024-1234',
  severity: 'HIGH',
  imageName: 'nginx:latest',
  fixedVersion: '1.25.1-1',
  pkgName: 'libssl3',
  installedVersion: '3.0.0-1',
};
