# syntax=docker/dockerfile:1
ARG VERSION="dev"
ARG REVISION="unknown"

FROM --platform=$BUILDPLATFORM golang:1.25-trixie AS agent-builder
ARG TARGETARCH
ARG BUILD_TAGS="exclude_frontend"
WORKDIR /build

RUN apt-get update && apt-get install -y --no-install-recommends git ca-certificates tzdata curl \
&& apt-get clean && rm -rf /var/lib/apt/lists/*

COPY ./.version ./VERSION
COPY ./backend/go.mod ./backend/go.sum ./
RUN go mod download

COPY ./backend ./backend

WORKDIR /build/backend
RUN --mount=type=cache,target=/root/.cache/go-build \
    VERSION=$(cat ../VERSION | tr -d '[:space:]') && \
    REVISION=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown") && \
    CGO_ENABLED=0 GOOS=linux GOARCH=$TARGETARCH \
    go build \
    -tags "${BUILD_TAGS}" \
    -ldflags "-w -s -X github.com/getarcaneapp/arcane/backend/internal/config.Version=${VERSION} -X github.com/getarcaneapp/arcane/backend/internal/config.Revision=${REVISION}" \
    -trimpath \
    -o /out/arcane-agent \
    ./cmd/main.go

FROM debian:trixie-slim AS agent
ARG TARGETARCH
RUN apt-get update && apt-get upgrade -y \
    && apt-get install -y --no-install-recommends ca-certificates curl tzdata \
    vainfo clinfo \
    && if [ "$TARGETARCH" = "amd64" ]; then \
        apt-get install -y --no-install-recommends intel-gpu-tools; \
    fi \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app
RUN mkdir -p /app/data

COPY --from=agent-builder /out/arcane-agent /usr/local/bin/arcane-agent

ARG VERSION="dev"
ARG REVISION="unknown"

ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    ROCR_VISIBLE_DEVICES=all \
    HIP_VISIBLE_DEVICES=all \
    ONEAPI_DEVICE_SELECTOR=level_zero:*,opencl:* \
    LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/rocm/lib:/opt/intel/oneapi/lib:/opt/intel/oneapi/lib/intel64:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib64:/usr/lib:/lib64:/lib

ENV ENVIRONMENT=production \
    AGENT_MODE=true \
    GIN_MODE=release \
    PORT=3553

LABEL org.opencontainers.image.authors="OFKM Technologies"
LABEL org.opencontainers.image.url="https://github.com/getarcaneapp/arcane"
LABEL org.opencontainers.image.documentation="https://github.com/getarcaneapp/arcane/blob/main/README.md"
LABEL org.opencontainers.image.source="https://github.com/getarcaneapp/arcane"
LABEL org.opencontainers.image.version=$VERSION
LABEL org.opencontainers.image.revision=$REVISION
LABEL org.opencontainers.image.licenses="BSD-3-Clause"
LABEL org.opencontainers.image.ref.name="arcane-agent"
LABEL org.opencontainers.image.title="Arcane Agent"
LABEL org.opencontainers.image.description="Arcane Agent"

LABEL com.getarcaneapp.arcane.updater="false"
LABEL com.getarcaneapp.arcane.server="true"

EXPOSE 3553
VOLUME ["/app/data"]

CMD ["/usr/local/bin/arcane-agent"]